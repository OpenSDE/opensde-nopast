# --- SDE-COPYRIGHT-NOTE-BEGIN ---
# This copyright note is auto-generated by ./scripts/Create-CopyPatch.
#
# Filename: target/share/squashfs.in
# Copyright (C) 2011 The OpenSDE Project
#
# More information can be found in the files COPYING and README.
#
# This program is free software; you can redistribute it and/or modify
# it under the terms of the GNU General Public License as published by
# the Free Software Foundation; version 2 of the License. A copy of the
# GNU General Public License can be found in the file COPYING.
# --- SDE-COPYRIGHT-NOTE-END ---

# source overlay functions, to wrap overlay_apply behind squashfs_install_overlay
#
. "$base/lib/overlay/overlay-functions.in"

# functions
#

# list the packages active for stage 1
squashfs_list_packages() {
	grep '^X' $base/config/$config/packages | cut -d' ' -f5
}

# install a package based on the flist and a given filter
squashfs_install_flist() {
	local pkg_name="$1" sandbox="$2" rootfs="$3"
	local flist="$sandbox/var/adm/flists/$pkg_name"
	shift 3

	sed "$@" "$flist" | cut -f2- -d' ' |
		tar -C "$sandbox/" -cf- --no-recursion --files-from=- |
		tar -C "$rootfs" -xf-
}

# weak functions
#
squashfs_install_overlay() {
	local x="$1/squashfs"
	[ ! -d "$x" ] || overlay_apply "$x" "$2"
}

# should this package be extracted by flist or not?
# squashfs_install <pkg_name> <sandbox> <rootfs>
squashfs_install() { true; }

# what arguments should it pass to sed to filter the flist?
# squashfs_install_pattern <pkg_name> <default_patterns>
squashfs_install_pattern() { shift; echo "$@"; }
