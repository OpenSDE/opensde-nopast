#!/bin/sh
# --- SDE-COPYRIGHT-NOTE-BEGIN ---
# This copyright note is auto-generated by ./scripts/Create-CopyPatch.
#
# Filename: bin/sde-cleanup-linger
# Copyright (C) 2006 - 2008 The OpenSDE Project
# Copyright (C) 2004 - 2006 The T2 SDE Project
# Copyright (C) 1998 - 2003 Clifford Wolf
#
# More information can be found in the files COPYING and README.
#
# This program is free software; you can redistribute it and/or modify
# it under the terms of the GNU General Public License as published by
# the Free Software Foundation; version 2 of the License. A copy of the
# GNU General Public License can be found in the file COPYING.
# --- SDE-COPYRIGHT-NOTE-END ---

#Description: Removes temp files and search for lingering files
#Alias: lingering

[ -n "$SDEROOT" ] ||
	export SDEROOT=$( cd "${0%/*}/.."; pwd -P )

. $SDEROOT/lib/libsde.in

if [ $# -ne 0 ]; then
	echo "Usage:	sde cleanup linger"
	exit 1
fi

cd "$SDEROOT"

echo_info "Searching for lingering temp/backup files (this may take some time) ..."

sderootdirs="scripts/. bin/. etc/. lib/. doc/. src/. package/. architecture/." # target/.

files_remove="-name *~ -o -name a.out -o -name core.* -o -name core"
files_warn="-name DEADJOE -o -name *-[xX]			\
	-o -name *.orig -o -name *.rej -o -name *#*		\
	-o -name *.mine -o -name *.r[1-9][0-9]*			\
	-o -name TRANS.TBL -o -name *.cksum-err -o -name x	\
	-o -name *[.-]old -o -name a.out -o -name *~		\
	-o -name *.incomplete -o -name *.ckext-err"

# Remove temp/backup files
#
( bin/find $sderootdirs target/. -type f \( $files_remove \) | xargs rm -vf ) &

# Print warnings for 'lingering' files
#
( bin/find ${sderootdirs} \(						\
	\( $files_warn -o -name '.[^.]*' \)				\
	-printf 'WARNING: Found %p\n'					\
  \) -o \(								\
	\( ! -type d ! -type f \)					\
	-printf 'WARNING: Neither a dir nor a regular file: %p\n'	\
  \) ) &

# for targets we tolerate .files
( bin/find target/. \( 							\
        \( $files_warn \)						\
        -printf 'WARNING: Found %p\n'                                   \
  \) -o \(                                                              \
        \( ! -type d ! -type f \)                                       \
        -printf 'WARNING: Neither a dir nor a regular file: %p\n'       \
  \) ) &

wait
exit 0
